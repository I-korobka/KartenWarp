# KartenWarpプログラム 国際化（i18n） 完全仕様書

## 1. 概要と目的
- **目的**  
  本仕様書は、KartenWarpプログラムの国際化対応を実装する際に、開発者が参照すべき「必読」のガイドラインとして策定されたものです。ソースコード中の文字列と翻訳データを明確に分離し、言語ごとに柔軟かつ正確な翻訳を実現するとともに、ユーザビリティ、文化的多様性、セキュリティ、保守性を確保します。

- **背景**  
  従来の仕様書には一部誤解や不整合が散見されましたが、今回の再構築では各言語特有の文法、敬称・丁寧語、単複数、動詞の活用、文字エンコーディング、UIレイアウトの問題など、i18nにおける多角的な課題に対応する設計思想を取り入れています。

---

## 2. 対象言語とロケール設計
- **サポート言語一覧**  
  - 日本語（ja/ja-JP）
  - 英語（en, en-GB, en-US など）
  - 標準ドイツ語（de, de-DE）
  - バイエルン語（ISO 639-3: bar）およびオーストリア方言（de-AT など）
  - さらに、二重君主国（オーストリア＝ハンガリー帝国）時代に使用された以下の言語  
    → ハンガリー語、チェコ語、スロバキア語、ポーランド語、ウクライナ語、クロアチア語、スロベニア語、ルーマニア語、イタリア語、セルボクロアチア語、ロシア語、イディッシュ語、ラテン語、その他関連言語

- **ロケール識別方法**  
  各言語はIETF言語タグ（BCP 47）を採用し、内部的にはハイフンをアンダースコアに変換、国コードは大文字（例: en-GB → en_GB、ja-JP → ja_JP）とします。言語タグが明示されない場合は、該当言語全般として処理し、対応リソースがない場合はデフォルト言語へフォールバックします。

---

## 3. 翻訳フレームワークとディレクトリ構成
- **採用ライブラリ**  
  GNU gettext（Python標準の`gettext`モジュール）を利用します。gettextの利点は、メッセージ抽出、PO/MOファイルによる翻訳管理、単数・複数形対応、文脈に応じた翻訳（pgettext）のサポートにあります。

- **ディレクトリ構成例**  
  ```
  locale/
  ├── ja_JP/
  │   └── LC_MESSAGES/
  │       └── messages.po (→ messages.mo)
  ├── en_GB/
  │   └── LC_MESSAGES/
  │       └── messages.po (→ messages.mo)
  ├── en_US/
  │   └── LC_MESSAGES/
  │       └── messages.po (→ messages.mo)
  ├── de_DE/
  │   └── LC_MESSAGES/
  │       └── messages.po (→ messages.mo)
  ├── bar/            ← バイエルン語（独立した言語コード）
  │   └── LC_MESSAGES/
  │       └── messages.po (→ messages.mo)
  ├── de_AT/          ← オーストリアドイツ語
  │   └── LC_MESSAGES/
  │       └── messages.po (→ messages.mo)
  ├── hu/             ← ハンガリー語
  │   └── LC_MESSAGES/
  │       └── messages.po (→ messages.mo)
  └── …（その他、必要な言語を追加）
  ```
  テンプレートファイルとして`messages.pot`を用い、各言語のPOファイルはこれを元に生成・更新します。

---

## 4. 実装ガイドライン
### 4.1. ソースコード中の文字列管理
- **文字列のマーキング**  
  翻訳対象の文字列は必ず`_()`で囲み、明示的に翻訳対象とします。例：  
  ```python
  print(_('Welcome, {name}!').format(name=username))
  ```

- **動的要素の取り扱い**  
  変数埋め込みが必要な場合は、Pythonの`str.format`または名前付きプレースホルダを利用し、翻訳ファイル側で自由に語順変更や活用形の調整が可能な設計とします。

- **複数形への対応**  
  数量に応じた単数形・複数形の変化は、`ngettext()`を利用して実装します。例：  
  ```python
  message = ngettext("{count} item is available.", "{count} items are available.", count)
  print(message.format(count=count))
  ```

- **文脈依存の翻訳**  
  同一原文が複数の意味を持つ場合、`pgettext()`などのコンテキスト指定を活用します。

### 4.2. 翻訳管理とワークフロー
- **メッセージ抽出とPOTファイル生成**  
  `xgettext`または`pygettext.py`を用いて、ソースコードから抽出したメッセージを`messages.pot`に出力します。

- **POファイルの作成と更新**  
  各言語ごとにPOTファイルを元にPOファイルを作成し、翻訳担当者が適切な訳文（文脈、敬称、単複、活用形などを考慮）を記入します。翻訳作業は必ずネイティブチェックまたは専門家レビューを経ること。

- **MOファイルへのコンパイル**  
  POファイルから`msgfmt`等のツールでMOファイルを生成し、実行時の高速なルックアップを実現します。

- **バージョン管理**  
  翻訳用のPOファイルはソースコードと同様にGit等で管理し、変更履歴を明確にします。

---

## 5. UIレイアウトおよびデザインの配慮
- **動的レイアウト**  
  各言語間で文字数や文節の長さが大きく異なるため、UIコンポーネントは可変長・自動リサイズ可能な設計とし、固定幅レイアウトは極力避けます。

- **フォントと文字表示**  
  全ての文字列はUTF-8エンコーディングで管理し、特殊文字（ウムラウト、アクセント記号、非ラテン文字等）に対応したフォントを適用します。各国固有の組版ルール（例：日本語の禁則処理、縦書きレイアウトなど）も考慮し、必要に応じたレイアウト調整を可能にします。

- **言語切替UI**  
  言語選択は、国旗や固定アイコンに依存せず、IETF言語タグやロケール識別子に基づく動的リストを生成する方式を採用します。

---

## 6. 文化・地域特有の課題への対応
- **敬称・丁寧語の管理**  
  日本語、ドイツ語、英語など各言語固有の敬称体系に対応するため、翻訳文中で適切な呼称や敬語レベル（例：「さん」「Mr./Ms.」「Sie/du」）を反映します。場合により、文脈に合わせた別キー（formal/informal）を用意します。

- **単数・複数・その他数量表現**  
  多くの言語では数量に応じた文法変化（単数・双数・複数）が必要です。POファイルの`Plural-Forms`設定に従い、ngettextによって適切な文を選択します。

- **動詞の活用と性・数の一致**  
  動詞の活用や形容詞の一致は、全体の文を翻訳文字列として用意し、プレースホルダで補完する方法を採用します。これにより、各言語で自然な文法が保たれるようにします。

- **文字列処理とソート**  
  文字列の境界、Unicode正規化、言語依存のコレーション（並び順）など、低レベルの文字処理に関しては、既存の信頼性の高いライブラリを活用するほか、各国の文化的背景（例：日本語の分かち書き、アラビア語の右→左書字）に配慮した実装を行います。

- **暦法とタイムゾーン**  
  各地域の暦法、タイムゾーン、夏時間（DST）など、日付・時刻の表示に関する文化差も十分に対応し、ユーザー設定または自動検出に基づいた表示を行います。

---

## 7. 開発上の注意事項
- **ハードコーディングの禁止**  
  全てのユーザー向けメッセージはソースコード内に直接記述せず、必ず翻訳ファイルから取得する方式を徹底します。

- **コード内ロジックの文化依存排除**  
  数値のフォーマット、日付の計算、文字列結合などにおいて、各国文化・言語依存の仮定（例：「1byte=1char」の前提など）を持たない実装を心掛けます。

- **将来的な拡張性**  
  新言語の追加はPO/MOファイルの追加と、言語リソースディレクトリの作成で完結するよう、コード上の分岐や固定処理は極力排除します。

---

## 8. 特記事項：多言語対応の包括的カバレッジ
- **初期段階からの多言語対応**  
  オーストリア語、バイエルン語、及び二重君主国時代の各言語（ハンガリー語、チェコ語、スロバキア語、ポーランド語、ウクライナ語、クロアチア語、スロベニア語、ルーマニア語、イタリア語、セルボクロアチア語、ロシア語、イディッシュ語、ラテン語など）は、最初からシステム設計の対象とします。  
  - 言語ごとの細かな文法規則、文字セット、暦法、UIデザインの違いを考慮し、各言語リソースの管理と表示検証を徹底してください。
  - 言語選択のUIは、国名や国旗に依存せず、正確な言語タグに基づいて動的に生成する仕組みを採用します。
